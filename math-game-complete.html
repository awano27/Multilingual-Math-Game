<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Dungeon - Complete Edition</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes heroFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        @keyframes monsterFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-8px) scale(1.05); }
        }
        @keyframes bossFloat {
            0%, 100% { transform: translateY(0px) scale(1) rotate(0deg); }
            25% { transform: translateY(-5px) scale(1.05) rotate(-5deg); }
            50% { transform: translateY(-10px) scale(1.1) rotate(0deg); }
            75% { transform: translateY(-5px) scale(1.05) rotate(5deg); }
        }
        @keyframes goalRotate {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        .animate-hero { animation: heroFloat 2s ease-in-out infinite; }
        .animate-monster { animation: monsterFloat 3s ease-in-out infinite; }
        .animate-boss { animation: bossFloat 1.5s ease-in-out infinite; }
        .animate-goal { animation: goalRotate 3s linear infinite; }
        
        /* Prevent text selection and zooming on mobile */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        /* Heart icon styles */
        .heart {
            display: inline-block;
            width: 30px;
            height: 30px;
        }
        .heart.filled {
            color: #ef4444;
        }
        .heart.empty {
            color: #d1d5db;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        const MathMazeGame = () => {
            // Language settings
            const [language, setLanguage] = useState('ja');
            
            // Translations (all languages)
            const translations = {
                ja: {
                    gameTitle: 'さんすうダンジョン',
                    startGame: 'ゲームスタート！',
                    stats: 'せいせき',
                    dictionary: 'モンスターずかん',
                    selectGrade: 'がくねんを えらぼう！',
                    grade2Mode: '2年生モード',
                    grade3Mode: '3年生モード',
                    studyContent: 'べんきょうする内容：',
                    addition: 'たし算',
                    subtraction: 'ひき算',
                    comparison: '数の大小くらべ',
                    multiplication: 'かけ算（九九）',
                    division: 'わり算（あまりなし）',
                    back: 'もどる',
                    level: 'レベル',
                    defeated: 'たおした',
                    timeLeft: 'のこり時間',
                    seconds: '秒',
                    correct: 'せいかい！すごいね！',
                    incorrect: 'ざんねん！もういちど！',
                    timeUp: 'じかんぎれ！もういちど！',
                    wall: 'かべだよ！べつの道をさがそう！',
                    gateBlocked: 'ボスをたおさないと とおれない！',
                    gateOpened: 'ゲートがひらいた！',
                    bossDefeated: 'ボスをたおした！ゲートがひらくよ！',
                    monsterDefeated: 'をたおした！',
                    levelClear: 'レベル',
                    clearMessage: 'クリア！',
                    nextLevel: 'つぎのレベルへ！',
                    menu: 'メニューへ',
                    becomeHero: 'さんすう勇者になって',
                    conquerDungeon: 'ダンジョンを制覇しよう！',
                    dungeonExploring: 'ダンジョン探索中',
                    bossBattle: 'ボスバトル！',
                    appeared: 'があらわれた！',
                    bossWarning: 'このボスをたおさないと ゴールできない！',
                    defeatedBoss: 'ボスをたおした！ゴールへ向かおう！',
                    needDefeatBoss: 'ボスをたおさないとゴールできない！',
                    you: 'じぶん',
                    monster: 'モンスター',
                    boss: 'ボス',
                    gate: 'ゲート',
                    goal: 'ゴール',
                    totalDefeated: 'ぜんぶでたおしたモンスター',
                    totalQuestions: 'といたもんだい',
                    correctAnswers: 'せいかいしたもんだい',
                    accuracy: 'せいかい率',
                    congratulations: 'おめでとう！',
                    yourStats: 'きみのせいせき',
                    found: 'みつけた',
                    notFound: 'まだみつけていないよ',
                    hp: 'たいりょく',
                    whichBigger: 'どちらが大きい？',
                    body: '体',
                    question: '問',
                    badges: 'バッジ',
                    firstClear: 'はじめてのクリア',
                    perfectClear: 'パーフェクト',
                    multiplicationMaster: '九九マスター',
                    typesOfMonsters: 'しゅるいのモンスター',
                    hint: 'ヒント: じぶんの学年にあったモードをえらぼう！',
                    viewHint: 'ヒントをみる',
                    hideHint: 'ヒントを隠す',
                    insectMission: '虫取りミッション',
                    selectArea: 'エリアを選ぼう',
                    urawa: '浦和',
                    omiya: '大宮',
                    iwatsuki: '岩槻',
                    cicada: 'セミ',
                    cicadaFact: '大宮公園ではセミがたくさん鳴いているよ。',
                    beetle: 'カブトムシ',
                    beetleFact: '浦和ではカブトムシが人気だよ。',
                    dragonfly: 'トンボ',
                    dragonflyFact: '見沼田んぼではトンボが飛び回っているよ。',
                    attemptCapture: '捕獲に挑戦',
                    captureInsect: '虫を捕まえよう',
                    captureSuccess: '捕獲成功！',
                    captureFail: '逃げられた！'
                },
                en: {
                    gameTitle: 'Math Dungeon',
                    startGame: 'Start Game!',
                    stats: 'Statistics',
                    dictionary: 'Monster Guide',
                    selectGrade: 'Choose Your Grade!',
                    grade2Mode: 'Grade 2 Mode',
                    grade3Mode: 'Grade 3 Mode',
                    studyContent: 'What to Study:',
                    addition: 'Addition',
                    subtraction: 'Subtraction',
                    comparison: 'Number Comparison',
                    multiplication: 'Multiplication',
                    division: 'Division',
                    back: 'Back',
                    level: 'Level',
                    defeated: 'Defeated',
                    timeLeft: 'Time Left',
                    seconds: 'sec',
                    correct: 'Correct! Great job!',
                    incorrect: 'Try again!',
                    timeUp: "Time's up! Try again!",
                    wall: "It's a wall! Find another way!",
                    gateBlocked: 'Defeat the boss to pass!',
                    gateOpened: 'Gate opened!',
                    bossDefeated: 'Boss defeated! Gate will open!',
                    monsterDefeated: ' defeated!',
                    levelClear: 'Level',
                    clearMessage: 'Clear!',
                    nextLevel: 'Next Level!',
                    menu: 'Menu',
                    becomeHero: 'Become a Math Hero',
                    conquerDungeon: 'Conquer the Dungeon!',
                    dungeonExploring: 'Exploring Dungeon',
                    bossBattle: 'Boss Battle!',
                    appeared: ' appeared!',
                    bossWarning: 'Defeat this boss to reach the goal!',
                    defeatedBoss: 'Boss defeated! Head to the goal!',
                    needDefeatBoss: 'Defeat the boss to reach the goal!',
                    you: 'You',
                    monster: 'Monster',
                    boss: 'Boss',
                    gate: 'Gate',
                    goal: 'Goal',
                    totalDefeated: 'Total Monsters Defeated',
                    totalQuestions: 'Questions Answered',
                    correctAnswers: 'Correct Answers',
                    accuracy: 'Accuracy',
                    congratulations: 'Congratulations!',
                    yourStats: 'Your Statistics',
                    found: 'Found',
                    notFound: 'Not discovered yet',
                    hp: 'HP',
                    whichBigger: 'Which is bigger?',
                    body: ' monsters',
                    question: ' questions',
                    badges: 'Badges',
                    firstClear: 'First Clear',
                    perfectClear: 'Perfect',
                    multiplicationMaster: 'Times Table Master',
                    typesOfMonsters: 'types of monsters',
                    hint: 'Hint: Choose the mode for your grade level!',
                    viewHint: 'Show Hint',
                    hideHint: 'Hide Hint',
                    insectMission: 'Insect Mission',
                    selectArea: 'Select Area',
                    urawa: 'Urawa',
                    omiya: 'Omiya',
                    iwatsuki: 'Iwatsuki',
                    cicada: 'Cicada',
                    cicadaFact: 'Many cicadas sing in Omiya Park.',
                    beetle: 'Beetle',
                    beetleFact: 'Beetles are popular in Urawa.',
                    dragonfly: 'Dragonfly',
                    dragonflyFact: 'Dragonflies fly around Minuma Tambo.',
                    attemptCapture: 'Attempt Capture',
                    captureInsect: 'Catch the insect',
                    captureSuccess: 'Captured!',
                    captureFail: 'It escaped!'
                },
                fr: {
                    gameTitle: 'Donjon des Maths',
                    startGame: 'Commencer!',
                    stats: 'Statistiques',
                    dictionary: 'Guide des Monstres',
                    selectGrade: 'Choisissez votre niveau!',
                    grade2Mode: 'Mode 2e année',
                    grade3Mode: 'Mode 3e année',
                    studyContent: 'À étudier:',
                    addition: 'Addition',
                    subtraction: 'Soustraction',
                    comparison: 'Comparaison',
                    multiplication: 'Multiplication',
                    division: 'Division',
                    back: 'Retour',
                    level: 'Niveau',
                    defeated: 'Vaincus',
                    timeLeft: 'Temps restant',
                    seconds: 'sec',
                    correct: 'Correct! Bravo!',
                    incorrect: 'Essaie encore!',
                    timeUp: 'Temps écoulé!',
                    wall: "C'est un mur!",
                    gateBlocked: 'Vaincs le boss pour passer!',
                    gateOpened: 'Porte ouverte!',
                    bossDefeated: 'Boss vaincu!',
                    monsterDefeated: ' vaincu!',
                    levelClear: 'Niveau',
                    clearMessage: 'Réussi!',
                    nextLevel: 'Niveau suivant!',
                    menu: 'Menu',
                    becomeHero: 'Deviens un héros des maths',
                    conquerDungeon: 'Conquiers le donjon!',
                    dungeonExploring: 'Exploration du donjon',
                    bossBattle: 'Combat de boss!',
                    appeared: ' est apparu!',
                    bossWarning: 'Vaincs ce boss pour atteindre le but!',
                    defeatedBoss: 'Boss vaincu! Dirige-toi vers le but!',
                    needDefeatBoss: 'Vaincs le boss pour atteindre le but!',
                    you: 'Toi',
                    monster: 'Monstre',
                    boss: 'Boss',
                    gate: 'Porte',
                    goal: 'But',
                    totalDefeated: 'Total de monstres vaincus',
                    totalQuestions: 'Questions répondues',
                    correctAnswers: 'Bonnes réponses',
                    accuracy: 'Précision',
                    congratulations: 'Félicitations!',
                    yourStats: 'Tes Statistiques',
                    found: 'Trouvé',
                    notFound: 'Pas encore découvert',
                    hp: 'PV',
                    whichBigger: 'Lequel est plus grand?',
                    body: ' monstres',
                    question: ' questions',
                    badges: 'Badges',
                    firstClear: 'Première victoire',
                    perfectClear: 'Parfait',
                    multiplicationMaster: 'Maître des tables',
                    typesOfMonsters: 'types de monstres',
                    hint: 'Astuce: Choisis le mode pour ton niveau!',
                    viewHint: "Voir l'indice",
                    hideHint: "Cacher l'indice",
                    insectMission: 'Mission Insecte',
                    selectArea: 'Choisir une zone',
                    urawa: 'Urawa',
                    omiya: 'Omiya',
                    iwatsuki: 'Iwatsuki',
                    cicada: 'Cigale',
                    cicadaFact: 'Beaucoup de cigales chantent au parc Omiya.',
                    beetle: 'Scarabée',
                    beetleFact: 'Les scarabées sont populaires à Urawa.',
                    dragonfly: 'Libellule',
                    dragonflyFact: 'Les libellules volent autour de Minuma Tambo.',
                    attemptCapture: 'Tenter la capture',
                    captureInsect: "Attrape l'insecte",
                    captureSuccess: 'Capturé!',
                    captureFail: 'S\'est échappé!'
                },
                zh: {
                    gameTitle: '数学地牢',
                    startGame: '开始游戏！',
                    stats: '统计',
                    dictionary: '怪物图鉴',
                    selectGrade: '选择年级！',
                    grade2Mode: '二年级模式',
                    grade3Mode: '三年级模式',
                    studyContent: '学习内容：',
                    addition: '加法',
                    subtraction: '减法',
                    comparison: '数字比较',
                    multiplication: '乘法',
                    division: '除法',
                    back: '返回',
                    level: '关卡',
                    defeated: '击败',
                    timeLeft: '剩余时间',
                    seconds: '秒',
                    correct: '正确！太棒了！',
                    incorrect: '再试一次！',
                    timeUp: '时间到！',
                    wall: '是墙！',
                    gateBlocked: '击败boss才能通过！',
                    gateOpened: '大门打开了！',
                    bossDefeated: 'Boss被击败！',
                    monsterDefeated: '被击败！',
                    levelClear: '关卡',
                    clearMessage: '通关！',
                    nextLevel: '下一关！',
                    menu: '菜单',
                    becomeHero: '成为数学英雄',
                    conquerDungeon: '征服地牢！',
                    dungeonExploring: '探索地牢中',
                    bossBattle: 'Boss战！',
                    appeared: '出现了！',
                    bossWarning: '击败这个boss才能到达终点！',
                    defeatedBoss: 'Boss被击败！前往终点！',
                    needDefeatBoss: '击败boss才能到达终点！',
                    you: '你',
                    monster: '怪物',
                    boss: 'Boss',
                    gate: '大门',
                    goal: '终点',
                    totalDefeated: '击败怪物总数',
                    totalQuestions: '回答问题数',
                    correctAnswers: '正确答案数',
                    accuracy: '正确率',
                    congratulations: '恭喜！',
                    yourStats: '你的统计',
                    found: '已发现',
                    notFound: '尚未发现',
                    hp: '生命值',
                    whichBigger: '哪个更大？',
                    body: '只',
                    question: '题',
                    badges: '徽章',
                    firstClear: '首次通关',
                    perfectClear: '完美',
                    multiplicationMaster: '九九表大师',
                    typesOfMonsters: '种怪物',
                    hint: '提示：选择适合你年级的模式！',
                    viewHint: '查看提示',
                    hideHint: '隐藏提示',
                    insectMission: '捕虫任务',
                    selectArea: '选择地区',
                    urawa: '浦和',
                    omiya: '大宫',
                    iwatsuki: '岩槻',
                    cicada: '蝉',
                    cicadaFact: '在大宫公园有很多蝉在叫。',
                    beetle: '甲虫',
                    beetleFact: '甲虫在浦和很受欢迎。',
                    dragonfly: '蜻蜓',
                    dragonflyFact: '蜻蜓在见沼田圃飞来飞去。',
                    attemptCapture: '尝试捕捉',
                    captureInsect: '来捕捉虫子',
                    captureSuccess: '捕捉成功！',
                    captureFail: '逃走了！'
                }
            };

            // insect capture helpers
            const startCapture = (insectKey) => {
                setCurrentInsect(insectKey);
                // Use addition problem for capture quiz (could be customized per insect)
                setCaptureQuestion(generateProblem('addition'));
                setCaptureResult(null);
                setGameState('insectQuiz');
            };

            const checkCaptureAnswer = (answer) => {
                if (!captureQuestion) return;
                if (answer === captureQuestion.answer) {
                    setCaptureResult('success');
                    if (currentInsect && !capturedInsects.includes(currentInsect)) {
                        setCapturedInsects(prev => [...prev, currentInsect]);
                    }
                } else {
                    setCaptureResult('fail');
                }
            };

            const t = translations[language];
            
            // Monster types with multilingual names
            const getMonsterTypes = () => {
                const monsterNames = {
                    ja: {
                        denkiryu: { name: 'デンキリュウ', desc: 'でんきタイプ！たし算で こうげきだ！' },
                        mizugame: { name: 'ミズガメ', desc: 'みずタイプ！ひき算の わざを はつ！' },
                        happamon: { name: 'ハッパモン', desc: 'くさタイプ！かずの ちからを くらべる！' },
                        honoodon: { name: 'ホノオドン', desc: 'ほのおタイプ！あつい たし算を だす！' },
                        starion: { name: 'スタリオン', desc: 'ほしタイプ！かけ算の ほしを ふらせる！' },
                        crystalos: { name: 'クリスタロス', desc: 'クリスタルタイプ！わり算で こうげき！' },
                        raidenking: { name: 'ライデンキング', desc: 'でんせつの ボス！たおさないと さきに すすめない！' },
                        mathemperor: { name: 'マスエンペラー', desc: 'さんすうの ていおう！九九を マスターしている！' }
                    },
                    en: {
                        denkiryu: { name: 'Electrox', desc: 'Electric type! Attacks with addition!' },
                        mizugame: { name: 'Aquaturtle', desc: 'Water type! Uses subtraction skills!' },
                        happamon: { name: 'Leafmon', desc: 'Grass type! Compares number powers!' },
                        honoodon: { name: 'Blazedon', desc: 'Fire type! Throws hot additions!' },
                        starion: { name: 'Starion', desc: 'Star type! Rains multiplication stars!' },
                        crystalos: { name: 'Crystalos', desc: 'Crystal type! Attacks with division!' },
                        raidenking: { name: 'Thunder King', desc: 'Legendary boss! Must defeat to proceed!' },
                        mathemperor: { name: 'Math Emperor', desc: 'Emperor of math! Master of times tables!' }
                    },
                    fr: {
                        denkiryu: { name: 'Électryx', desc: 'Type électrique! Attaque avec addition!' },
                        mizugame: { name: 'Aquatortue', desc: 'Type eau! Utilise la soustraction!' },
                        happamon: { name: 'Feuilmon', desc: 'Type plante! Compare les nombres!' },
                        honoodon: { name: 'Flammedon', desc: 'Type feu! Lance des additions brûlantes!' },
                        starion: { name: 'Étoilon', desc: 'Type étoile! Pleut des multiplications!' },
                        crystalos: { name: 'Crystalos', desc: 'Type cristal! Attaque avec division!' },
                        raidenking: { name: 'Roi Tonnerre', desc: 'Boss légendaire! À vaincre pour continuer!' },
                        mathemperor: { name: 'Empereur Math', desc: 'Empereur des maths! Maître des tables!' }
                    },
                    zh: {
                        denkiryu: { name: '电龙', desc: '电系！用加法攻击！' },
                        mizugame: { name: '水龟', desc: '水系！使用减法技能！' },
                        happamon: { name: '叶兽', desc: '草系！比较数字力量！' },
                        honoodon: { name: '火焰兽', desc: '火系！发出炽热的加法！' },
                        starion: { name: '星兽', desc: '星系！降下乘法之星！' },
                        crystalos: { name: '水晶兽', desc: '水晶系！用除法攻击！' },
                        raidenking: { name: '雷王', desc: '传说中的Boss！必须击败才能前进！' },
                        mathemperor: { name: '数学皇帝', desc: '数学的帝王！掌握九九表！' }
                    }
                };

                return [
                    // Grade 2 monsters
                    {
                        id: 'denkiryu',
                        name: monsterNames[language].denkiryu.name,
                        emoji: '⚡',
                        problemType: 'addition',
                        description: monsterNames[language].denkiryu.desc,
                        isBoss: false,
                        grade: 2,
                        health: 3
                    },
                    {
                        id: 'mizugame',
                        name: monsterNames[language].mizugame.name,
                        emoji: '🐢',
                        problemType: 'subtraction',
                        description: monsterNames[language].mizugame.desc,
                        isBoss: false,
                        grade: 2,
                        health: 3
                    },
                    {
                        id: 'happamon',
                        name: monsterNames[language].happamon.name,
                        emoji: '🍃',
                        problemType: 'comparison',
                        description: monsterNames[language].happamon.desc,
                        isBoss: false,
                        grade: 2,
                        health: 3
                    },
                    {
                        id: 'honoodon',
                        name: monsterNames[language].honoodon.name,
                        emoji: '🔥',
                        problemType: 'addition',
                        description: monsterNames[language].honoodon.desc,
                        isBoss: false,
                        grade: 2,
                        health: 3
                    },
                    // Grade 3 monsters
                    {
                        id: 'starion',
                        name: monsterNames[language].starion.name,
                        emoji: '⭐',
                        problemType: 'multiplication',
                        description: monsterNames[language].starion.desc,
                        isBoss: false,
                        grade: 3,
                        health: 3
                    },
                    {
                        id: 'crystalos',
                        name: monsterNames[language].crystalos.name,
                        emoji: '💎',
                        problemType: 'division',
                        description: monsterNames[language].crystalos.desc,
                        isBoss: false,
                        grade: 3,
                        health: 3
                    },
                    // Boss monsters
                    {
                        id: 'raidenking',
                        name: monsterNames[language].raidenking.name,
                        emoji: '👑',
                        problemType: 'addition',
                        description: monsterNames[language].raidenking.desc,
                        isBoss: true,
                        grade: 2,
                        health: 5
                    },
                    {
                        id: 'mathemperor',
                        name: monsterNames[language].mathemperor.name,
                        emoji: '🏰',
                        problemType: 'multiplication',
                        description: monsterNames[language].mathemperor.desc,
                        isBoss: true,
                        grade: 3,
                        health: 7
                    }
                ];
            };
            
            // Game state
            const [gameState, setGameState] = useState('menu');
            const [currentLevel, setCurrentLevel] = useState(1);
            const [selectedGrade, setSelectedGrade] = useState(2);
            const [playerPosition, setPlayerPosition] = useState({ x: 0, y: 0 });
            const [maze, setMaze] = useState([]);
            const [mazeSize, setMazeSize] = useState(5);
            const [monsterPositions, setMonsterPositions] = useState([]);
            const [defeatedMonsters, setDefeatedMonsters] = useState([]);
            const [currentMonster, setCurrentMonster] = useState(null);
            const [battleState, setBattleState] = useState(null);
            const [bossGates, setBossGates] = useState([]);
            const [requiredBosses, setRequiredBosses] = useState([]);
            const [timeLeft, setTimeLeft] = useState(30);
            const [message, setMessage] = useState('');
            const [showHint, setShowHint] = useState(false);
            const [selectedArea, setSelectedArea] = useState(null);
            const [currentInsect, setCurrentInsect] = useState(null);
            const [captureQuestion, setCaptureQuestion] = useState(null);
            const [captureResult, setCaptureResult] = useState(null);
            const [capturedInsects, setCapturedInsects] = useState([]);
            const [playerStats, setPlayerStats] = useState({
                totalMonstersDefeated: 0,
                totalQuestionsAnswered: 0,
                correctAnswers: 0,
                unlockedMonsters: [],
                badges: []
            });

            const areaInsects = {
                urawa: { insect: 'beetle' },
                omiya: { insect: 'cicada' },
                iwatsuki: { insect: 'dragonfly' }
            };

            // Language selector component
            const LanguageSelector = () => (
                <div className="flex justify-center gap-2 mb-4">
                    <button 
                        onClick={() => setLanguage('ja')} 
                        className={`px-3 py-1 rounded text-sm font-bold transition-all ${
                            language === 'ja' 
                                ? 'bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-lg' 
                                : 'bg-gray-300 hover:bg-gray-400'
                        }`}
                    >
                        日本語
                    </button>
                    <button 
                        onClick={() => setLanguage('en')} 
                        className={`px-3 py-1 rounded text-sm font-bold transition-all ${
                            language === 'en' 
                                ? 'bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-lg' 
                                : 'bg-gray-300 hover:bg-gray-400'
                        }`}
                    >
                        EN
                    </button>
                    <button 
                        onClick={() => setLanguage('fr')} 
                        className={`px-3 py-1 rounded text-sm font-bold transition-all ${
                            language === 'fr' 
                                ? 'bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-lg' 
                                : 'bg-gray-300 hover:bg-gray-400'
                        }`}
                    >
                        FR
                    </button>
                    <button 
                        onClick={() => setLanguage('zh')} 
                        className={`px-3 py-1 rounded text-sm font-bold transition-all ${
                            language === 'zh' 
                                ? 'bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-lg' 
                                : 'bg-gray-300 hover:bg-gray-400'
                        }`}
                    >
                        中文
                    </button>
                </div>
            );

            // Save language preference
            useEffect(() => {
                const saved = localStorage.getItem('gameLanguage');
                if (saved && translations[saved]) setLanguage(saved);
            }, []);

            useEffect(() => {
                localStorage.setItem('gameLanguage', language);
            }, [language]);

            // Generate maze (fixed version)
            const generateMaze = useCallback((size) => {
                const newMaze = Array(size).fill().map(() => Array(size).fill(0));
                
                // Add walls more strategically
                for (let i = 0; i < size; i++) {
                    for (let j = 0; j < size; j++) {
                        if (Math.random() < 0.2 && !(i === 0 && j === 0) && !(i === size-1 && j === size-1)) {
                            newMaze[i][j] = 1; // Wall
                        }
                    }
                }
                
                // Ensure path exists from start to goal
                newMaze[0][0] = 0; // Start
                newMaze[size-1][size-1] = 2; // Goal
                
                // Clear a basic path
                for (let i = 0; i < size - 1; i++) {
                    if (Math.random() < 0.5) {
                        newMaze[i][i] = 0;
                        newMaze[i][i+1] = 0;
                    } else {
                        newMaze[i][i] = 0;
                        newMaze[i+1][i] = 0;
                    }
                }
                
                // Add gate if level > 3
                const gates = [];
                const bosses = [];
                if (currentLevel > 3 && size >= 7) {
                    const gateY = size - 2;
                    const gateX = size - 1;
                    if (newMaze[gateY][gateX] === 0) {
                        newMaze[gateY][gateX] = 3; // Gate
                        gates.push({ x: gateX, y: gateY, id: 'gate-1' });
                    }
                }
                
                // Get grade-appropriate monsters
                const monsterTypes = getMonsterTypes();
                const gradeMonsters = monsterTypes.filter(m => m.grade === selectedGrade);
                const normalMonsters = gradeMonsters.filter(m => !m.isBoss);
                const bossMonsters = gradeMonsters.filter(m => m.isBoss);
                
                // Add monsters
                const monsters = [];
                
                // Add boss if there's a gate
                if (gates.length > 0 && bossMonsters.length > 0) {
                    let bossPlaced = false;
                    for (let attempts = 0; attempts < 50 && !bossPlaced; attempts++) {
                        const x = Math.floor(Math.random() * (size - 2)) + 1;
                        const y = Math.floor(Math.random() * (size - 2)) + 1;
                        
                        if (newMaze[y][x] === 0 && 
                            !(x === 0 && y === 0) && 
                            !(x === size-1 && y === size-1)) {
                            const bossType = bossMonsters[Math.floor(Math.random() * bossMonsters.length)];
                            const bossMonster = { 
                                x, 
                                y, 
                                type: bossType,
                                id: `boss-${gates[0].id}`,
                                isBoss: true
                            };
                            monsters.push(bossMonster);
                            bosses.push(bossMonster.id);
                            bossPlaced = true;
                        }
                    }
                }
                
                // Add normal monsters
                const monsterCount = Math.min(Math.floor(size / 2), 4);
                for (let i = 0; i < monsterCount; i++) {
                    let placed = false;
                    let attempts = 0;
                    while (!placed && attempts < 50) {
                        const x = Math.floor(Math.random() * size);
                        const y = Math.floor(Math.random() * size);
                        if (newMaze[y][x] === 0 && 
                            !(x === 0 && y === 0) && 
                            !(x === size-1 && y === size-1) &&
                            !monsters.some(m => m.x === x && m.y === y)) {
                            const monsterType = normalMonsters[Math.floor(Math.random() * normalMonsters.length)];
                            monsters.push({ 
                                x, 
                                y, 
                                type: monsterType,
                                id: `monster-${i}`,
                                isBoss: false
                            });
                            placed = true;
                        }
                        attempts++;
                    }
                }
                
                setMaze(newMaze);
                setMonsterPositions(monsters);
                setBossGates(gates);
                setRequiredBosses(bosses);
                setPlayerPosition({ x: 0, y: 0 });
                setDefeatedMonsters([]);
            }, [currentLevel, selectedGrade, language]);

            // Generate problem (fixed comparison)
            const generateProblem = (type) => {
                let problem = {};

                switch (type) {
                    case 'addition':
                        const add_a = Math.floor(Math.random() * 20) + 1;
                        const add_b = Math.floor(Math.random() * 20) + 1;
                        problem = {
                            question: `${add_a} + ${add_b} = ?`,
                            answer: add_a + add_b,
                            options: generateOptions(add_a + add_b, 2, 40),
                            hint: `${add_a} + ${add_b} = ?`
                        };
                        break;

                    case 'subtraction':
